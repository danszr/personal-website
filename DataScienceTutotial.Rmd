---
title: "cmsc320finalproject"
author: "Dan Selzer"
date: "May 17, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# New York Taxi Cab Data

Daniel Selzer

## Outline
Introduction

Installing libraries and loading data

## Introduction

When is the cheapest time of day to ride a taxi in New York City? What factors affect how much a Taxi ride costs? The goal of this tutorial is to provide a way to answer that question via introduction to the data science process by providing an overivew of how to import data into R as a dataFrame, tidy the data, visualize the data, and conduct regressions, and conduct hypothesis tests using the data. To do this, we will utilize the New York City Taxicab dataset publicly available online at nyc.gov, which contains detailed anonymized taxi trip data.

## Installing Libraries and Loading Data

To conduct this tutorial, several R libraries are used, and we will import them here.
```{r start}
  library(rvest)
  library(magrittr)
  library(tidyverse)
  library(stringr)
```

To load in the New York Taxi Cab Dataset, use the read_csv command. We will use data from December 2017, which is the most recent month for which data is available. As this file is quite large, I recommend only loading the file once, and then not loading it again after that. We use the head() command in order to show the first few rows of the dataframe, to examine it's format.
```{r load_data}
trip_data <- read_csv("https://s3.amazonaws.com/nyc-tlc/trip+data/yellow_tripdata_2017-12.csv")
head(trip_data)
```
## Tidying the Data

Now that we have the dataset downloaded into RStudio, we can start to tidy it up into a format that is best suited for our analysis. This dataset is already quite tidy to begin with since it doesn't have many missing values and the data seems to be in a format that's easy to work with. However, one change to the data that we will make is creating separate columns for the day of the year, month, day, and hour for pickup. Since we will assume that the date is the same (or one day different) for dropoff we do not need a separate column for dropoff date. We will also create a trip duration column. Next, to get rid of some outliers that are not supposed  to be in this dataset, we filter the data to remove any trips that didnot occur in December 2017. Next, since the pickup and dropoff zones are numbers, we will join it with another dataset from nyc.gov which will allow us to specify the actual names of the boroughs and neighborhoods where the zone numbers are. We will also use filter() to filter out erronous outliers and then take a small sample of data since the original data set is too large to work with. To learn more about tidying data with dyplr and tidyr, visit http://dplyr.tidyverse.org/ and http://tidyr.tidyverse.org/

```{r tidying}
neighborhooddata <- read_csv("https://s3.amazonaws.com/nyc-tlc/misc/taxi+_zone_lookup.csv")
head(neighborhooddata)
  
trip_data <- trip_data %>%
    mutate(pickup_year = as.numeric(format(trip_data$tpep_pickup_datetime, "%Y"))) %>%
    mutate(pickup_month = as.numeric(format(trip_data$tpep_pickup_datetime, "%m"))) %>%
    mutate(pickup_day = as.numeric(format(trip_data$tpep_pickup_datetime, "%d"))) %>%
    mutate(pickup_hour = as.numeric(format(trip_data$tpep_pickup_datetime, "%H"))) %>%
    mutate(trip_duration = tpep_dropoff_datetime - tpep_pickup_datetime) %>%
    merge(neighborhooddata, by.x = "PULocationID", by.y = "LocationID") %>%
    filter(pickup_year == 2017 && pickup_month == 12 && fare_amount < 500 && fare_amount > 0 && trip_duration < 12000) %>% sample_n(100000)
head(trip_data)
```

## Visualizing and Exploring the Data

After tidying the data a little bit, it is now in a format in which we can start to visualize it in order to get a feel to some insights that it may be able to provide. To do this, we will use the ggplot2 plackage, which is commonly used in R to create data visualizations. To learn more about graphing data with ggplot2, visit http://ggplot2.tidyverse.org/

First, let's get a sense of what the time vs fare relation is. To do this, let's plot a scatterplot with the independent variable as the pickup day and the dependent variable as the fare amount, and color code it by the pickup borough.

```{r dayVSfare}
    trip_data %>%
  ggplot(aes(x=pickup_day, y=fare_amount)) +
    geom_point(aes(color=factor(Borough.y))) +
    labs(title="Fare vs Day",
         x = "Day of Month",
         y = "Fare")
```
From the graph, the fare tends to be relative constant day to day, wth slight variations in the distribution of fares. To examine these variations, let's use a violin plot, which is a plot that, instead of plotting points for each independentvalue, displays a visualization of the distribution of the dependent value for each independent value. The vast majority of pickups are in Manhattan, with Queens in second.

```{r dayVSfareViolin}
    trip_data %>%
  ggplot(aes(x=factor(pickup_day), y=fare_amount)) +
    geom_violin() +
    labs(title="Fare vs Day of Month",
         x = "Day of Month",
         y = "Fare")
```
From this graph, it appears that some days have greater ranges of fare than others, including the 1st, 20th, and 26th, although the median fare appears to remain constant within the days (no surge pricing!?)

```{r hourVSfare}
    trip_data %>%
  ggplot(aes(x=pickup_hour, y=fare_amount)) +
    geom_point(aes(color=factor(Borough.y))) +
    labs(title="Fare vs Hour",
         x = "Hour",
         y = "Fare")
```
From this plot, there appears to be some hours where the fare may get more expensive, such as 3pm and 6pm. Again let's examine a violin plot.

```{r hourVSfareViolin}
    trip_data %>%
  ggplot(aes(x=factor(pickup_hour), y=fare_amount)) +
    geom_violin() +
    labs(title="Fare vs Hour",
         x = "Hour",
         y = "Fare")
```
The violin plot shows that at 12am, 3pm and 5pm there are higher spreads in fares, but the median essentially stays the same across all hours of the day.

Next, let's get a sense of what the distance vs fare relation is. To do this, let's plot a scatterplot with the independent variable as the trip_distance and the dependent variable as the fare amount. Let's color code this by borough to see if any borough distinctions help up understand the relationship better.

```{r durationVSfare}
    trip_data %>%
  ggplot(aes(x=trip_duration, y=fare_amount)) +
    geom_point(aes(color=factor(Borough.y))) +
    labs(title="Fare vs Duration (seconds)",
         x = "Duration (seconds)",
         y = "Fare")
```
From this plot there appears to be a positive correlation between trip duration and fare upuntil about 7000 seconds (2 hours). However, there appears to be a large group of outliers at around 80000 seconds (1333 hours)

Next, let's do the same with duration. To do this, let's plot a scatterplot with the independent variable as the trip_duration and the dependent variable as the fare amount. Let's keep the color coding by borough to see if any borough distinctions help us understand the relationship better.

```{r distanceVSfare}
    trip_data %>%
  ggplot(aes(x=trip_distance, y=fare_amount)) +
    geom_point(aes(color=factor(Borough.y))) +
    labs(title="Fare vs Distance",
         x = "Distance",
         y = "Fare")
```
From this plot there appears to be a clear position correlation between distance and fare.

Next, let's see if any correlation exists between passenger count and fare.
```{r passengerCountVSfare}
    trip_data %>%
  ggplot(aes(x=passenger_count, y=fare_amount)) +
    geom_point(aes(color=factor(Borough.y))) +
    scale_x_continuous(breaks = c(0, 1, 2, 3, 4, 5, 6)) + 
    labs(title="Fare vs Passenger Count",
         x = "Passenger Count",
         y = "Fare")
```
It appears that rides with 1 or 2 passengers may have a higher spread than rides with more than 2 passengers. Again, the violin plot: 

```{r passengerCountVSfareViolin}
    trip_data %>%
  ggplot(aes(x=factor(passenger_count), y=fare_amount)) +
    geom_violin() +
    labs(title="Fare vs Passenger Count",
         x = "Passenger Count",
         y = "Fare")
```
It appears that the passenger count does not affect the median drastically, although the spread is higher for rides with 1 or 2 passengers.

##Regression and Hypothesis Testing

Now that we have explored the data a bit and made some hypotheses about correlations between some of the variables and fare, let's try to confirm or deny them by conducting a multiple linear regression, including all of the factors that we have examined in the visualization section. To learn more about multiple linear regression, visit http://www.stat.yale.edu/Courses/1997-98/101/linmult.htm

```{r regression}
  linearModel <- lm(fare_amount~factor(Borough.y)+pickup_day+pickup_hour+trip_duration+trip_distance+passenger_count, trip_data)

summary(linearModel)
```
From this linear model, since the p-value for the f-statistic is below 0.05, we can conclude that at least one of the variables in the linear model is signifcant in explaining the fare at the 0.05 siginificance level. Additionally, since the p-values for pickup_day, pickup_hour, trip_duration, and trip_distance are below 0.05, we can conclude that these variables are siginifcant in explaining fare in this model, which contradicts what we originally thought, but there might have been variations in some of the graphs that we couldn't notice. Also, it appears that whether or not a trip begins a trip begins in Brooklyn, EWR (Newark Airport), or Staten Island are also helpful in explaining fares. It appears that fares for trips starting in Brooklyn are slight lower than those starting in the Bronx, whereas fares for trips starting in EWR are significantly higher (34.71 dollars) than those starting in the Bronx, and fares for trips starting in Staten Island are significantly lower (37.76 dollars) than those starting in the bronx.

##Insights

From this tutorial, we have gained invaluable skills in obtaining data from a source, tidying it up so it can be worked it, visualizing it through graphs and plots, and drawing conclusions based on linear models.
We have also gained useful insights for the next trip to New York, including minimizing the distance and duration of Taxi Rides, and not riding all the way from Newark Airport, assuming the end goal is to save money. 

While this tutorial is a good start to gathering insights from this data, infinitely more insights can be gained from playing around with the tools available in R, so I encourage you to try to do more with this dataset on your own.